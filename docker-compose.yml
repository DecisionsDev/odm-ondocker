version: '3'
services:
  dbserver:
    image: $REPOSITORY/dbserver:$ODMVERSION
    build:
        context: ../
        dockerfile: ./${ODMDOCKERDIR}/databases/postgresql/Dockerfile
        args:
        - ODMDOCKERDIR=$ODMDOCKERDIR
        - ODMDBVERSION=$ODMDBVERSION
        - FROMPOSTGRES=$FROMPOSTGRES
    user: "999:999"
    ports:
    - 5432:5432
    environment:
      - POSTGRES_USER=odmusr
      - POSTGRES_PASSWORD=odmpwd
      - POSTGRES_DB=odmdb
      - PGDATA=/var/lib/postgresql/data
      - SAMPLE=false
# Uncomment this line to persist your data. Note that on OSX you need to share this
# current directory in the Preference menu -> File Sharing menu.
#    volumes:
#      - ./pgdata:/pgdata

  odm-decisionserverconsole:
    image: $REPOSITORY/$PREFIXIMAGE-decisionserverconsole:$ODMVERSION
    build:
      context: ../
      dockerfile: ./${ODMDOCKERDIR}/decisionserver/decisionserverconsole/Dockerfile
      args:
        - ODMDOCKERDIR=$ODMDOCKERDIR
        - ODMVERSION=$ODMVERSION
        - FROMLIBERTY=$FROMLIBERTY
#    user: "1001:0"
    links:
    - dbserver
    depends_on:
    - dbserver
    ports:
    - 9080:9080
    - 1883:1883
    - 9843:9443
    environment:
#    - RedirectHost=https://9.145.151.103:9843
     - RedirectHost=https://9.145.84.100:9843
    volumes:
    - ${PWD}/ums/ums.xml:/config/auth/ums.xml
    - ${PWD}/ums/logging.xml:/config/logging/logging.xml
    - ${PWD}/ums/dsc-application.xml:/config/application.xml
    - ${PWD}/ums/odmkeystore.jks:/config/resources/security/odmkeystore.jks
    - ${PWD}/ums/odmtruststore.jks:/config/resources/security/odmtruststore.jks
    - ${PWD}/decisionserver/decisionserverconsole/config/server.xml:/config/server.xml
#    - ${PWD}/ums/web.xml:/config/apps/res.war/WEB-INF/web.xml
#    - ${PWD}/ums/web.xml:/config/apps/DecisionService.war/WEB-INF/web.xml
  odm-decisionrunner:
    image: $REPOSITORY/$PREFIXIMAGE-decisionrunner:$ODMVERSION
    build:
      context: ../
      dockerfile: ./${ODMDOCKERDIR}/decisionserver/decisionrunner/Dockerfile
      args:
        - ODMDOCKERDIR=$ODMDOCKERDIR
        - ODMVERSION=$ODMVERSION
        - FROMLIBERTY=$FROMLIBERTY
    user: "1001:0"
    links:
    - dbserver
    - odm-decisionserverconsole
    depends_on:
    - dbserver
    - odm-decisionserverconsole
    ports:
    - 9070:9080
    - 9743:9443
    environment:
#    - RedirectHost=https://9.145.151.103:9743
     - RedirectHost=https://9.145.84.100:9743
    volumes:
    - ${PWD}/ums/ums.xml:/config/auth/ums.xml
#    - ${PWD}/ums/logging.xml:/config/logging/logging.xml
    - ${PWD}/ums/dr-application.xml:/config/application.xml
    - ${PWD}/ums/odmkeystore.jks:/config/resources/security/odmkeystore.jks
    - ${PWD}/ums/odmtruststore.jks:/config/resources/security/odmtruststore.jks

  odm-decisionserverruntime:
    image: $REPOSITORY/$PREFIXIMAGE-decisionserverruntime:$ODMVERSION
    build:
      context: ../
      dockerfile: ./${ODMDOCKERDIR}/decisionserver/decisionserverruntime/Dockerfile
      args:
        - ODMDOCKERDIR=$ODMDOCKERDIR
        - ODMVERSION=$ODMVERSION
        - FROMLIBERTY=$FROMLIBERTY
    user: "1001:0"
    environment:
      - DECISIONSERVERCONSOLE_NAME=odm-decisionserverconsole
    links:
    - dbserver
    - odm-decisionserverconsole
    depends_on:
    - dbserver
    - odm-decisionserverconsole
    ports:
    - 9090:9080
    - 9943:9443
    environment:
#    - RedirectHost=https://9.145.151.103:9943
    - RedirectHost=https://9.145.84.100:9943
    volumes:
    - ${PWD}/ums/ums.xml:/config/auth/ums.xml
 #   - ${PWD}/ums/logging.xml:/config/logging/logging.xml
    - ${PWD}/ums/dsr-application.xml:/config/application.xml
    - ${PWD}/ums/odmkeystore.jks:/config/resources/security/odmkeystore.jks
    - ${PWD}/ums/odmtruststore.jks:/config/resources/security/odmtruststore.jks

  odm-decisioncenter:
    image: $REPOSITORY/$PREFIXIMAGE-decisioncenter:$ODMVERSION
    build:
      context: ../
      dockerfile: ./${ODMDOCKERDIR}/decisioncenter/Dockerfile
      args:
        - ODMDOCKERDIR=$ODMDOCKERDIR
        - ODMVERSION=$ODMVERSION
        - FROMLIBERTY=$FROMLIBERTY
    user: "1001:0"
    links:
    - dbserver
    depends_on:
    - dbserver
    ports:
    - 9060:9060
    - 9643:9453
    environment:
#    - RedirectHost=https://9.145.151.103:9643
    - RedirectHost=https://9.145.84.100:9643
    volumes:
    - ${PWD}/ums/ums.xml:/config/auth/ums.xml
#    - ${PWD}/ums/logging.xml:/config/logging/logging.xml
    - ${PWD}/ums/dc-jvm.options:/config/jvm.options
    - ${PWD}/ums/webSecurity.xml:/config/auth/webSecurity.xml
    - ${PWD}/ums/dc-application.xml:/config/application.xml
    - ${PWD}/ums/odmkeystore.jks:/config/resources/security/odmkeystore.jks
    - ${PWD}/ums/odmtruststore.jks:/config/resources/security/odmtruststore.jks
#    - ${PWD}/ums/OdmOidcProviders.json:/config/resources/security/OdmOidcProviders.json
    - ${PWD}/ums/OdmOidcProviders.json:/config/apps/decisioncenter.war/WEB-INF/classes/OdmOidcProviders.json
